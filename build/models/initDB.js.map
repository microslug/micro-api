{"version":3,"sources":["../../src/models/initDB.js"],"names":["promiseFactory","require","promise","redis","client","process","env","REDISTOGO_URL","rtg","parse","createClient","host","hostname","port","auth","split","REDIS_HOST","REDIS_PORT","dbConnected","on","logger","log","err","error","get","then","reply","console","message","dbKeySize","send_command","db"],"mappings":";;;;;;;AAMA;;AAEA,IAAIA,iBAAiBC,QAAQ,MAAR,EAAgBC,OAArC;AAAA,IACEC,QAAQF,QAAQ,eAAR,EAAyBD,cAAzB,CADV,C,CARA;;;;;;AAWA,IAAII,eAAJ;;AAEA,IAAIC,QAAQC,GAAR,CAAYC,aAAhB,EAA+B;AAC7B;AACA,MAAMC,MAAMP,QAAQ,KAAR,EAAeQ,KAAf,CAAqBJ,QAAQC,GAAR,CAAYC,aAAjC,CAAZ;AACAH,WAASD,MAAMO,YAAN,CAAmB;AAC1BC,UAAMH,IAAII,QADgB;AAE1BC,UAAML,IAAIK;AAFgB,GAAnB,CAAT;AAIAT,SAAOU,IAAP,CAAYN,IAAIM,IAAJ,CAASC,KAAT,CAAe,GAAf,EAAoB,CAApB,CAAZ;AACD,CARD,MAQO;AACL;AACAX,WAASD,MAAMO,YAAN,CAAmB;AAC1BC,UAAMN,QAAQC,GAAR,CAAYU,UADQ;AAE1BH,UAAMR,QAAQC,GAAR,CAAYW;AAFQ,GAAnB,CAAT;AAID;;AAEM,IAAIC,oCAAc,KAAlB;;AAEPd,OAAOe,EAAP,CAAU,SAAV,EAAqB,YAAM;AACzB,UAHSD,WAGT,iBAAc,IAAd;AACAE,iBAAOC,GAAP,CAAW,MAAX,EAAkB,yBAAlB;AACD,CAHD;AAIAjB,OAAOe,EAAP,CAAU,OAAV,EAAmB,UAACG,GAAD,EAAS;AAC1B,UAPSJ,WAOT,iBAAc,KAAd;AACAE,iBAAOG,KAAP,CAAa,0BAAb,EAAwCD,GAAxC;AACD,CAHD;;AAMAlB,OAAOoB,GAAP,CAAW,aAAX,EAA0BC,IAA1B,CAAiC,UAACC,KAAD,EAAOH,KAAP,EAAiB;AAChD,MAAIA,KAAJ,EAAW;AACT,WAAOI,QAAQN,GAAR,CAAY,SAAZ,EAAuBC,IAAIM,OAA3B,CAAP;AACD;AACDR,iBAAOC,GAAP,CAAW,MAAX,EAAkB,yBAAuBK,KAAzC;AACD,CALD;;AAOO,IAAIG,gCAAY,IAAhB;;AAGPzB,OAAO0B,YAAP,CAAqB,QAArB,EAA+BL,IAA/B,CAAsC,UAACC,KAAD,EAAOH,KAAP,EAAiB;AACrD,MAAIA,KAAJ,EAAW;AACT,WAAOI,QAAQN,GAAR,CAAY,SAAZ,EAAuBC,IAAIM,OAA3B,CAAP;AACD;AACD,UAPSC,SAOT,eAAYH,KAAZ;AACD,CALD;AAMO,IAAMK,kBAAK3B,MAAX","file":"initDB.js","sourcesContent":["/********************************************************************************\n *\n * Initialize Redis DB\n *\n ********************************************************************************/\n\nimport { logger } from '../utils/logger';\n\nvar promiseFactory = require('when').promise,\n  redis = require('promise-redis')(promiseFactory);\n\nlet client;\n\nif (process.env.REDISTOGO_URL) {\n  // heroku\n  const rtg = require('url').parse(process.env.REDISTOGO_URL);\n  client = redis.createClient({\n    host: rtg.hostname,\n    port: rtg.port,\n  });\n  client.auth(rtg.auth.split(':')[1]);\n} else {\n  // local\n  client = redis.createClient({\n    host: process.env.REDIS_HOST,\n    port: process.env.REDIS_PORT,\n  });\n}\n\nexport let dbConnected = false;\n\nclient.on('connect', () => {\n  dbConnected = true;\n  logger.log('info','Redis client connected.');\n});\nclient.on('error', (err) => {\n  dbConnected = false;\n  logger.error('Unable to connect to DB ',err);\n});\n\n\nclient.get('slugCounter').then ( (reply,error) => {\n  if (error) {\n    return console.log('Error: ', err.message);\n  }\n  logger.log('info','Database key size = '+reply);\n});\n\nexport let dbKeySize = null;\n\n\nclient.send_command( 'dbsize').then ( (reply,error) => {\n  if (error) {\n    return console.log('Error: ', err.message);\n  }\n  dbKeySize = reply;\n});\nexport const db = client;\n"]}