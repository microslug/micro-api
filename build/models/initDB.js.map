{"version":3,"sources":["../../src/models/initDB.js"],"names":["require","config","promiseFactory","promise","redis","client","process","env","REDISTOGO_URL","rtg","parse","createClient","host","hostname","port","auth","split","K8SPASSWORD","logger","info","REDIS_HOST","REDIS_PORT","password","dbConnected","on","log","err","error","get","then","reply","console","message","dbKeySize","send_command","db"],"mappings":";;;;;;;AAMA;;AACAA,QAAQ,QAAR,EAAkBC,MAAlB,G,CAPA;;;;;;AASA,IAAIC,iBAAiBF,QAAQ,MAAR,EAAgBG,OAArC;AAAA,IACEC,QAAQJ,QAAQ,eAAR,EAAyBE,cAAzB,CADV;;AAGA,IAAIG,eAAJ;;AAEA,IAAIC,QAAQC,GAAR,CAAYC,aAAhB,EAA+B;AAC7B;AACA,MAAMC,MAAMT,QAAQ,KAAR,EAAeU,KAAf,CAAqBJ,QAAQC,GAAR,CAAYC,aAAjC,CAAZ;AACAH,WAASD,MAAMO,YAAN,CAAmB;AAC1BC,UAAMH,IAAII,QADgB;AAE1BC,UAAML,IAAIK;AAFgB,GAAnB,CAAT;AAIAT,SAAOU,IAAP,CAAYN,IAAIM,IAAJ,CAASC,KAAT,CAAe,GAAf,EAAoB,CAApB,CAAZ;AACD,CARD,MAQO,IAAIV,QAAQC,GAAR,CAAYU,WAAhB,EAA6B;AAClC;AACAC,iBAAOC,IAAP,CAAY,0CAAZ;AACAd,WAASD,MAAMO,YAAN,CAAmB;AAC1BC,UAAMN,QAAQC,GAAR,CAAYa,UADQ;AAE1BN,UAAMR,QAAQC,GAAR,CAAYc,UAFQ;AAG1BC,cAAUhB,QAAQC,GAAR,CAAYU;AAHI,GAAnB,CAAT;AAKD,CARM,MAQA;AACL;AACAZ,WAASD,MAAMO,YAAN,CAAmB;AAC1BC,UAAMN,QAAQC,GAAR,CAAYa,UADQ;AAE1BN,UAAMR,QAAQC,GAAR,CAAYc;AAFQ,GAAnB,CAAT;AAID;;AAEM,IAAIE,oCAAc,KAAlB;;AAEPlB,OAAOmB,EAAP,CAAU,SAAV,EAAqB,YAAM;AACzB,UAHSD,WAGT,iBAAc,IAAd;AACAL,iBAAOO,GAAP,CAAW,MAAX,EAAkB,yBAAlB;AACD,CAHD;AAIApB,OAAOmB,EAAP,CAAU,OAAV,EAAmB,UAACE,GAAD,EAAS;AAC1B,UAPSH,WAOT,iBAAc,KAAd;AACAL,iBAAOS,KAAP,CAAa,0BAAb,EAAwCD,GAAxC;AACD,CAHD;;AAMArB,OAAOuB,GAAP,CAAW,aAAX,EAA0BC,IAA1B,CAAiC,UAACC,KAAD,EAAOH,KAAP,EAAiB;AAChD,MAAIA,KAAJ,EAAW;AACT,WAAOI,QAAQN,GAAR,CAAY,SAAZ,EAAuBC,IAAIM,OAA3B,CAAP;AACD;AACDd,iBAAOO,GAAP,CAAW,MAAX,EAAkB,yBAAuBK,KAAzC;AACD,CALD;;AAOO,IAAIG,gCAAY,IAAhB;;AAGP5B,OAAO6B,YAAP,CAAqB,QAArB,EAA+BL,IAA/B,CAAsC,UAACC,KAAD,EAAOH,KAAP,EAAiB;AACrD,MAAIA,KAAJ,EAAW;AACT,WAAOI,QAAQN,GAAR,CAAY,SAAZ,EAAuBC,IAAIM,OAA3B,CAAP;AACD;AACD,UAPSC,SAOT,eAAYH,KAAZ;AACD,CALD;AAMO,IAAMK,kBAAK9B,MAAX","file":"initDB.js","sourcesContent":["/********************************************************************************\n *\n * Initialize Redis DB\n *\n ********************************************************************************/\n\nimport { logger } from '../utils/logger';\nrequire('dotenv').config();\n\nvar promiseFactory = require('when').promise,\n  redis = require('promise-redis')(promiseFactory);\n\nlet client;\n\nif (process.env.REDISTOGO_URL) {\n  // heroku\n  const rtg = require('url').parse(process.env.REDISTOGO_URL);\n  client = redis.createClient({\n    host: rtg.hostname,\n    port: rtg.port,\n  });\n  client.auth(rtg.auth.split(':')[1]);\n} else if (process.env.K8SPASSWORD) {\n  // kubernetes\n  logger.info('Connecting to Kubernetes Redis instance.');\n  client = redis.createClient({\n    host: process.env.REDIS_HOST,\n    port: process.env.REDIS_PORT,\n    password: process.env.K8SPASSWORD\n  });\n} else {\n  // local\n  client = redis.createClient({\n    host: process.env.REDIS_HOST,\n    port: process.env.REDIS_PORT,\n  });\n}\n\nexport let dbConnected = false;\n\nclient.on('connect', () => {\n  dbConnected = true;\n  logger.log('info','Redis client connected.');\n});\nclient.on('error', (err) => {\n  dbConnected = false;\n  logger.error('Unable to connect to DB ',err);\n});\n\n\nclient.get('slugCounter').then ( (reply,error) => {\n  if (error) {\n    return console.log('Error: ', err.message);\n  }\n  logger.log('info','Database key size = '+reply);\n});\n\nexport let dbKeySize = null;\n\n\nclient.send_command( 'dbsize').then ( (reply,error) => {\n  if (error) {\n    return console.log('Error: ', err.message);\n  }\n  dbKeySize = reply;\n});\nexport const db = client;\n"]}